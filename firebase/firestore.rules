rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is an admin
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/Admin/$(request.auth.uid));
    }

    // Helper function to check if user has admin role in Users collection
    function isUserAdmin() {
      return request.auth != null &&
             get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.role == 'admin';
    }

    // Combined admin check
    function isAuthenticated() {
      return request.auth != null;
    }

    // Users collection - users can only access their own data
    match /Users/{userId} {
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin() || isUserAdmin());
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAuthenticated() && (request.auth.uid == userId || isAdmin() || isUserAdmin());
    }

    // Routes collection - only admins can create/modify, everyone can read
    match /Routes/{document} {
      allow read: if true;  // Public read access for all users
      allow create: if isAdmin() || isUserAdmin();
      allow update: if isAdmin() || isUserAdmin();
      allow delete: if isAdmin() || isUserAdmin();
    }

    // Admin collection - highly restricted, only existing admins can manage
    match /Admin/{document} {
      allow read: if isAdmin() || isUserAdmin();
      allow create: if false;  // Must be created via backend/manually
      allow update: if isAdmin() || isUserAdmin();
      allow delete: if false;  // Prevent accidental admin deletion
    }

    // Fares collection - only admins can manage, everyone can read
    match /Fares/{document} {
      allow read: if true;  // Public read access for fare information
      allow create: if isAdmin() || isUserAdmin();
      allow update: if isAdmin() || isUserAdmin();
      allow delete: if isAdmin() || isUserAdmin();
    }

    // FCM tokens - users can manage their own tokens
    match /Users/{userId}/fcm_tokens/{tokenId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Push notifications - only admins can create
    match /ff_push_notifications/{document} {
      allow read: if isAdmin() || isUserAdmin();
      allow write: if isAdmin() || isUserAdmin();
    }
  }
}
